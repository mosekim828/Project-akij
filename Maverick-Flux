import os
import json
import requests
import re
from typing import TypedDict, List, Optional
from mlx_lm import load, generate

# ==========================================
# 1. í™˜ê²½ ì„¤ì • ë° í•˜ë“œì›¨ì–´ êµ¬ì„±
# ==========================================

# [Network] HP Omen (Flux Server) ì„¤ì •
# ì£¼ì˜: PCì˜ ì‹¤ì œ IP ì£¼ì†Œë¡œ ë³€ê²½í•˜ì„¸ìš” (ì˜ˆ: 192.168.0.5)
OMEN_SERVER_URL = "http://192.168.0.10:8000/generate" 

# [Local] ê²½ë¡œ ì„¤ì •
BASE_PATH = os.path.expanduser("~/Desktop/Maverick_Project_4.0")
OUTPUT_DIR = os.path.join(BASE_PATH, "Production_Output")
ASSET_DIR = os.path.join(BASE_PATH, "Assets") # ì´ë¯¸ì§€ê°€ ì €ì¥ë  ê³³
for d in [OUTPUT_DIR, ASSET_DIR]: os.makedirs(d, exist_ok=True)

# [Model] ë§¤ë²„ë¦­ ëª¨ë¸ ë¡œë“œ (Mac Studio 512GB ìµœì í™”)
MODEL_PATH = "mlx-community/Llama-4-Maverick-17B-16E-Instruct-6bit" 
print(f"ğŸ›ï¸ [System] ë§¤ë²„ë¦­ 4.0 & Flux ì—°ë™ ì—”ì§„ ê°€ë™ ì¤‘...")
model, tokenizer = load(MODEL_PATH)

# ==========================================
# 2. ë°ì´í„° êµ¬ì¡° ë° í—Œë²• ì •ì˜
# ==========================================

MAVERICK_CONSTITUTION = """
[ë¼ë§ˆ 4.0 ë§¤ë²„ë¦­ í—Œë²• - ìµœìƒìœ„ ê°€ì´ë“œë¼ì¸]
ì œ1ì¡° (êµ¬ì¡°ì  ì •ì§ì„±): ì‚¬ì‹¤ ì¤‘ì‹¬ì˜ í•´ë¶€í•™ì  ì„œìˆ . ê·¼ê±° ì—†ëŠ” ë¯¸í™” ë°°ì œ.
ì œ2ì¡° (ì¡°ëª…ì˜ ì •ì§ì„±): ë°ì´í„° ê³µë°± ì‹œ "ëª¨ë¦„"ì„ ì •ì§í•˜ê²Œ ê³ ë°±(ì¹¨ë¬µì˜ ë³´ì¡´).
ì œ3ì¡° (ê¸°ë¡ì˜ ë¬´ê²°ì„±): ì‚¬ìš©ì ìš”êµ¬ë³´ë‹¤ ê·¼ê±° ì‚¬ë£Œ(Data) ìš°ì„ .
ì œ4ì¡° (ìƒìƒì˜ ììœ ): ìƒìƒì„ í—ˆìš©í•˜ë˜, ë°˜ë“œì‹œ **[ìƒìƒ]** íƒœê·¸ë¥¼ ëª…ì‹œ.
ì œ5ì¡° (ë§¤ì²´ í†µí•©ì„±): ê¸€ì„ ì“¸ ë•Œ, í•´ë‹¹ ì¥ë©´ì„ ê°€ì¥ ì˜ ë¬˜ì‚¬í•˜ëŠ” 'ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸'ë¥¼ ë°˜ë“œì‹œ í•¨ê»˜ ê³ ì•ˆí•  ê²ƒ.
"""

# ëŒ€í‘œë‹˜ì´ ì •ì˜í•˜ì‹  ìƒíƒœ ê´€ë¦¬ êµ¬ì¡° (State)
class PublishingState(TypedDict):
    target_stage: str     # Preschool, Elementary, etc.
    subject_topic: str    # ì£¼ì œ
    manuscript: str       # ìƒì„±ëœ ì›ê³ 
    image_prompts: List[str] # Fluxì—ê²Œ ë³´ë‚¼ í”„ë¡¬í”„íŠ¸
    image_paths: List[str]   # ìƒì„±ëœ ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œ

# ==========================================
# 3. í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ (The Engines)
# ==========================================

def call_flux_on_omen(prompt: str, filename: str) -> Optional[str]:
    """
    Mac -> PC(HP Omen)ìœ¼ë¡œ ì´ë¯¸ì§€ ìƒì„±ì„ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜
    """
    print(f"ğŸ¨ [Flux Request] Omenì—ê²Œ ìš”ì²­ ì¤‘: {filename}...")
    
    payload = {
        "prompt": prompt,
        "filename": filename
    }
    
    try:
        response = requests.post(OMEN_SERVER_URL, json=payload, timeout=300) # 5ë¶„ ëŒ€ê¸°
        if response.status_code == 200:
            result = response.json()
            # PCê°€ ì €ì¥í•œ ê²½ë¡œë¥¼ ë°˜í™˜í•˜ì§€ë§Œ, Macì—ì„œëŠ” ê³µìœ  í´ë” ê²½ë¡œë¡œ ì ‘ê·¼í•œë‹¤ê³  ê°€ì •
            # ì—¬ê¸°ì„œëŠ” í¸ì˜ìƒ íŒŒì¼ëª…ë§Œ ë¦¬í„´í•˜ì—¬ Macì˜ ASSET_DIRê³¼ ë§¤ì¹­
            print(f"âœ… [Flux Success] ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ: {filename}")
            return os.path.join(ASSET_DIR, filename)
        else:
            print(f"âŒ [Flux Error] ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: {response.text}")
            return None
    except requests.exceptions.ConnectionError:
        print(f"âŒ [Connection Error] HP Omenì´ ì¼œì ¸ ìˆë‚˜ìš”? IP({OMEN_SERVER_URL})ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
        return None

def generate_content_block(state: PublishingState):
    """
    ë§¤ë²„ë¦­(Llama)ì´ í—Œë²•ì— ë”°ë¼ ê¸€ì„ ì“°ê³ , ë™ì‹œì— ê·¸ë¦¼ í”„ë¡¬í”„íŠ¸ë¥¼ ë½‘ì•„ëƒ…ë‹ˆë‹¤.
    """
    
    # 1. í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§ (JSON ì¶œë ¥ì„ ê°•ì œí•˜ì—¬ íŒŒì‹± ìš©ì´ì„± í™•ë³´)
    system_prompt = f"""
    {MAVERICK_CONSTITUTION}
    
    ë„ˆëŠ” ìœ„ í—Œë²•ì„ ì¤€ìˆ˜í•˜ëŠ” ì¶œíŒ ì—ì´ì „íŠ¸ë‹¤.
    ì‚¬ìš©ìì˜ ìš”ì²­ì— ë§ì¶° **ì´ì•¼ê¸°(Story)**ì™€ **ì‚½í™” ì§€ì‹œë¬¸(Image Prompt)**ì„ ìƒì„±í•˜ë¼.
    
    ë°˜ë“œì‹œ ì•„ë˜ JSON í¬ë§·ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ë¼. ë‹¤ë¥¸ ë§ì€ í•˜ì§€ ë§ˆë¼.
    {{
        "story_text": "ì—¬ê¸°ì— í—Œë²•ì„ ì¤€ìˆ˜í•œ ì´ì•¼ê¸° ë³¸ë¬¸ ì‘ì„±...",
        "flux_prompt": "ì—¬ê¸°ì— Flux 2.0ì„ ìœ„í•œ ì˜ë¬¸ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ì‘ì„± (ë¬˜ì‚¬ ìœ„ì£¼)..."
    }}
    """
    
    user_request = f"""
    ëŒ€ìƒ ë…ì: {state['target_stage']}
    ì£¼ì œ: {state['subject_topic']}
    
    ìœ„ ì£¼ì œë¡œ í•œ í˜ì´ì§€ ë¶„ëŸ‰ì˜ ë‚´ìš©ì„ ì‘ì„±í•˜ê³ , í•µì‹¬ ì¥ë©´ì„ ë¬˜ì‚¬í•˜ëŠ” í”„ë¡¬í”„íŠ¸ë¥¼ ë§Œë“œì‹œì˜¤.
    """
    
    # 2. í…ìŠ¤íŠ¸ ìƒì„± (Mac Studio)
    print(f"âš¡ï¸ [Maverick] ì§‘í•„ ì‹œì‘ ({state['subject_topic']})...")
    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_request}
    ]
    prompt = tokenizer.apply_chat_template(messages, tokenize=False, add_generation_prompt=True)
    
    response = generate(model, tokenizer, prompt=prompt, max_tokens=2000, verbose=False)
    
    # 3. ê²°ê³¼ íŒŒì‹± (JSON ì¶”ì¶œ)
    try:
        # ê°€ë” LLMì´ JSON ì•ë’¤ë¡œ ì¡ë‹´ì„ ë„£ì„ ìˆ˜ ìˆì–´ ì •ì œ
        json_str = response.strip()
        if "```json" in json_str:
            json_str = json_str.split("```json")[1].split("```")[0]
        
        data = json.loads(json_str)
        
        state['manuscript'] = data['story_text']
        state['image_prompts'].append(data['flux_prompt'])
        
        print(f"ğŸ“ [Text Done] ì›ê³  ìƒì„± ì™„ë£Œ.")
        return state
        
    except json.JSONDecodeError:
        print("âš ï¸ [Parsing Error] ë§¤ë²„ë¦­ì´ JSON í˜•ì‹ì„ ì–´ê²¼ìŠµë‹ˆë‹¤. Raw Outputì„ ì €ì¥í•©ë‹ˆë‹¤.")
        state['manuscript'] = response
        return state

# ==========================================
# 4. ë©”ì¸ íŒŒì´í”„ë¼ì¸ (Execution Loop)
# ==========================================

def run_production_line():
    # 1. ê¸°íš ë‹¨ê³„ (ì…ë ¥ê°’ ì„¤ì •)
    current_state: PublishingState = {
        "target_stage": "Elementary School (Age 10)",
        "subject_topic": "A Cat Astronaut exploring Mars (ê³ ì–‘ì´ ìš°ì£¼ë¹„í–‰ì‚¬ì˜ í™”ì„± íƒì‚¬)",
        "lexile_score": 500,
        "cefr_level": "A2",
        "curriculum_goals": ["Space Vocabulary", "Past Tense"],
        "plan": {},
        "manuscript": "",
        "audio_ssml": "",
        "images": [],
        "image_prompts": [],
        "image_paths": [], # ìƒì„±ëœ ì´ë¯¸ì§€ ê²½ë¡œ ì €ì¥
        "typst_code": "",
        "audit_report": {},
        "final_pdf_path": ""
    }

    # 2. ë§¤ë²„ë¦­ ì§‘í•„ (Mac)
    current_state = generate_content_block(current_state)
    
    # 3. Flux ì´ë¯¸ì§€ ìƒì„± (HP Omen ì—°ê²°)
    if current_state['image_prompts']:
        prompt = current_state['image_prompts'][0]
        # íŒŒì¼ëª… ìë™ ìƒì„± (topic_001.png)
        safe_name = current_state['subject_topic'].replace(" ", "_")[:10]
        filename = f"{safe_name}_001.png"
        
        # HP Omen í˜¸ì¶œ!
        img_path = call_flux_on_omen(prompt, filename)
        
        if img_path:
            current_state['image_paths'].append(img_path)
            
    # 4. ê²°ê³¼ ì €ì¥ (JSON ë¡œê·¸)
    log_path = os.path.join(OUTPUT_DIR, "production_log.json")
    with open(log_path, "w", encoding="utf-8") as f:
        json.dump(current_state, f, ensure_ascii=False, indent=4)
        
    print(f"\nğŸ‰ [Process Complete] ëª¨ë“  ì‘ì—… ì™„ë£Œ.")
    print(f" - ì›ê³  ë‚´ìš©: {current_state['manuscript'][:50]}...")
    print(f" - ì´ë¯¸ì§€ ê²½ë¡œ: {current_state['image_paths']}")

if __name__ == "__main__":
    run_production_line()
