import subprocess
import re
import os
import json
import datetime
from mlx_lm import load, generate

# ==========================================
# [ì„¤ì •] ëª¨ë¸ ê²½ë¡œ ë° íŒŒì¼ ì„¤ì •
# ==========================================
# ì‚¬ìš©ìë‹˜ì˜ Mac Studio ë‚´ ëª¨ë¸ ê²½ë¡œ
MODEL_PATH = "/Users/juson/.cache/huggingface/hub/models--mlx-community--Llama-4-Maverick-17B-16E-Instruct-6bit/snapshots/542ea389fcd614c665c4306bd60ad053d9da8d03" 
MEMORY_FILE = "maverick_memory.json"
OUTPUT_FILE = "maverick_output.typ"

print(f"â³ [System] ë§¤ë²„ë¦­(Typst Specialist)ì„ ë¡œë“œí•©ë‹ˆë‹¤... ({MODEL_PATH})")
try:
    model, tokenizer = load(MODEL_PATH)
    print("âœ… [System] ë¡œë“œ ì™„ë£Œ. ë§¤ë²„ë¦­ì´ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.")
except Exception as e:
    print(f"âŒ [Error] ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨: {e}")
    exit()

# ==========================================
# 1. ê¸°ì–µ ì‹œìŠ¤í…œ (Memory System)
# ==========================================
class MaverickMemory:
    def __init__(self, filename):
        self.filename = filename
        self.data = self._load()

    def _load(self):
        if os.path.exists(self.filename):
            with open(self.filename, 'r', encoding='utf-8') as f:
                return json.load(f)
        return {"lessons": [], "successful_snippets": []}

    def save(self):
        with open(self.filename, 'w', encoding='utf-8') as f:
            json.dump(self.data, f, ensure_ascii=False, indent=2)

    def add_lesson(self, error_summary, fix_note):
        """ì‹¤íŒ¨ í›„ ì„±ê³µí–ˆì„ ë•Œ êµí›ˆ ì €ì¥"""
        entry = {
            "date": str(datetime.datetime.now())[:19],
            "error": error_summary,
            "fix": fix_note
        }
        self.data["lessons"].append(entry)
        self.save()

    def get_knowledge(self):
        """ê³¼ê±°ì˜ êµí›ˆì„ í”„ë¡¬í”„íŠ¸ì— ì£¼ì…í•˜ê¸° ìœ„í•´ ë¶ˆëŸ¬ì˜´"""
        if not self.data["lessons"]:
            return "ì•„ì§ ê¸°ë¡ëœ ì‹¤íŒ¨/ì„±ê³µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
        # ìµœê·¼ 3ê°œì˜ êµí›ˆë§Œ ê°€ì ¸ì˜´ (ì»¨í…ìŠ¤íŠ¸ ì ˆì•½)
        recent_lessons = self.data["lessons"][-3:]
        return "\n".join([f"- ì£¼ì˜ì‚¬í•­: {l['error']} -> í•´ê²°ì±…: {l['fix']}" for l in recent_lessons])

memory = MaverickMemory(MEMORY_FILE)

# ==========================================
# 2. ë§¤ë²„ë¦­ì˜ ë‘ë‡Œ (Generation)
# ==========================================
def ask_maverick(mission, error_log="", memory_context=""):
    """
    ë§¤ë²„ë¦­ì—ê²Œ ì½”ë“œë¥¼ ìš”ì²­í•©ë‹ˆë‹¤. (ê¸°ì–µ + í˜„ì¬ìƒí™© + ì—ëŸ¬ë¡œê·¸ í†µí•©)
    """
    
    # ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸: Typst ì „ë¬¸ê°€ë¡œì„œì˜ ì •ì²´ì„± ê°•í™”
    system_msg = f"""
    You are Maverick, a world-class Typst typesetter and developer.
    
    [YOUR MEMORY & RULES]:
    {memory_context}
    
    1. Output ONLY valid Typst code inside ```typst ... ``` blocks.
    2. Do NOT use LaTeX syntax (like \\begin or \\section). Use Typst syntax (#set, =, ==).
    3. If an error log is provided, analyze it and FIX the code specifically.
    """
    
    if error_log:
        user_msg = f"""
        [MISSION]: {mission}
        
        [PREVIOUS ERROR LOG]:
        {error_log}
        
        [INSTRUCTION]:
        The previous code failed to compile. Read the error log above carefully.
        Fix the error and provide the complete corrected code.
        """
    else:
        user_msg = f"[MISSION]: {mission}\n\nWrite the complete Typst code."

    messages = [
        {"role": "system", "content": system_msg},
        {"role": "user", "content": user_msg}
    ]
    
    # í…œí”Œë¦¿ ì ìš©
    try:
        prompt_formatted = tokenizer.apply_chat_template(messages, tokenize=False, add_generation_prompt=True)
    except:
        prompt_formatted = f"System: {system_msg}\nUser: {user_msg}\nAssistant:"

    print("ğŸ§  [Maverick] ì½”ë“œë¥¼ ì„¤ê³„í•˜ëŠ” ì¤‘...")
    
    # MLX ìƒì„± (ì˜µì…˜ ìµœì†Œí™”ë¡œ ì˜¤ë¥˜ ë°©ì§€)
    response = generate(
        model, 
        tokenizer, 
        prompt=prompt_formatted, 
        max_tokens=2500,  # ì½”ë“œê°€ ê¸¸ì–´ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë„‰ë„‰í•˜ê²Œ
        verbose=False     
    )
    
    return response

# ==========================================
# 3. ì‹¤í–‰ ë° ê²€ì¦ (Execution)
# ==========================================
def extract_code(text):
    match = re.search(r"```typst(.*?)```", text, re.DOTALL)
    if match:
        return match.group(1).strip()
    if "#set" in text or "#show" in text: # ë°±ì—…: ì½”ë“œë¸”ë¡ ì—†ì–´ë„ ì½”ë“œ ê°™ìœ¼ë©´ ì¶”ì¶œ
        return text.strip()
    return ""

def compile_typst(filename):
    try:
        result = subprocess.run(
            ["typst", "compile", filename],
            capture_output=True, text=True
        )
        if result.returncode == 0:
            return True, "Compilation Success"
        else:
            return False, result.stderr.strip()
    except FileNotFoundError:
        return False, "Typst command not found. Install it via 'brew install typst'"

# ==========================================
# 4. ë©”ì¸ ì—ì´ì „íŠ¸ ë£¨í”„ (Training Loop)
# ==========================================
def training_session(mission_description):
    print(f"\nğŸ¯ [New Mission] {mission_description}")
    
    # ê¸°ì–µ ë¡œë“œ
    current_knowledge = memory.get_knowledge()
    print(f"ğŸ“‚ [Memory] ë§¤ë²„ë¦­ì˜ ì§€ì‹ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.")
    
    error_log = ""
    
    # ìµœëŒ€ 5ë²ˆì˜ ìˆ˜ì • ê¸°íšŒ (ìê°€ ì¹˜ìœ )
    for attempt in range(1, 6):
        print(f"\n--- [Attempt {attempt}/5] ---")
        
        # 1. ìƒê° (Think)
        response = ask_maverick(mission_description, error_log, current_knowledge)
        
        # 2. í–‰ë™ (Act - Code Writing)
        code = extract_code(response)
        if not code:
            print("âš ï¸ ì½”ë“œë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.")
            error_log = "Error: No code block found inside ```typst ... ```. Please provide code."
            continue
            
        with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
            f.write(code)
        print("ğŸ“„ ì½”ë“œë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.")
        
        # 3. ê²€ì¦ (Check)
        success, msg = compile_typst(OUTPUT_FILE)
        
        if success:
            print(f"ğŸ‰ [ì„±ê³µ!] PDFê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: {OUTPUT_FILE.replace('.typ', '.pdf')}")
            
            # ì‹¤íŒ¨ë¥¼ ë”›ê³  ì„±ê³µí–ˆë‹¤ë©´, êµí›ˆ ì €ì¥ (í•™ìŠµ)
            if attempt > 1:
                print("ğŸ“ [í•™ìŠµ] ì˜¤ë¥˜ ìˆ˜ì • ê²½í—˜ì„ 'ì¥ê¸° ê¸°ì–µ(JSON)'ì— ì €ì¥í•©ë‹ˆë‹¤.")
                memory.add_lesson(
                    error_summary=error_log[:100] + "...", # ë¡œê·¸ ìš”ì•½
                    fix_note="Self-corrected based on compiler feedback."
                )
            
            # Macì—ì„œ PDF ìë™ ì—´ê¸°
            subprocess.run(["open", OUTPUT_FILE.replace('.typ', '.pdf')])
            return True
            
        else:
            print(f"ğŸ’¥ [ì‹¤íŒ¨] ì»´íŒŒì¼ ì—ëŸ¬ ë°œìƒ:\n{msg}")
            # ì—ëŸ¬ ë¡œê·¸ë¥¼ ë‹¤ìŒ í„´ì˜ ì»¨í…ìŠ¤íŠ¸ë¡œ ë„˜ê¹€
            error_log = msg 
            
    print("ğŸ’€ [Mission Failed] 5ë²ˆì˜ ì‹œë„ ëì— í•´ê²°í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
    return False

# ==========================================
# ì‹¤í–‰ë¶€
# ==========================================
if __name__ == "__main__":
    # â–¼â–¼â–¼ ì—¬ê¸°ì— ì›í•˜ëŠ” Typst ë¯¸ì…˜ì„ ì ì–´ì£¼ì„¸ìš” â–¼â–¼â–¼
    mission = """
    A4 ì‚¬ì´ì¦ˆ í˜ì´ì§€ë¥¼ ì„¤ì •í•´ì¤˜.
    ìƒë‹¨ì—ëŠ” 'Maverick's Learning Log'ë¼ëŠ” í—¤ë”ë¥¼ ë„£ê³ ,
    ë³¸ë¬¸ì€ 2ë‹¨(columns: 2)ìœ¼ë¡œ ë‚˜ëˆ„ì–´ì¤˜.
    ë‚´ìš©ì€ 'Lorem Ipsum'ì„ 5ë¬¸ë‹¨ ì •ë„ ì±„ì›Œì„œ ë ˆì´ì•„ì›ƒì„ ë³´ì—¬ì¤˜.
    """
    
    training_session(mission)
